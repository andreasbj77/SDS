---
title: "R Notebook"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	message = FALSE,
	warning = FALSE,
	fig.align = "center")
  rm(list=ls())
  Sys.setenv(LANG = "en")
  options(scipen = 5)
```

```{r}
library(readr)
library(tidyverse)
library(magrittr)
library(readxl)
```

# Fetching the data

The data was originally recieved as a .bak file which was converted into a .sql file using SQL. The data was exported as Excell sheets from SQL, and therefore the data is loaded into R using a custom made function.
```{r}
read_excel_allsheets <- function(filename, tibble = FALSE) {
    sheets <- readxl::excel_sheets(filename)
    x <- lapply(sheets, function(X) readxl::read_excel(filename, sheet = X))
    if(!tibble) x <- lapply(x, as.data.frame)
    names(x) <- sheets
    x
}
```

Since the data consist of 3 herds the data is loaded in 3 separate sheets. The data sets can be downloaded at [Github](https://github.com/andreasbj77/SDS/tree/main/Project/Data) until the 26th of January 2021.
```{r}
setwd("C:/Users/andre/OneDrive/Skrivebord/R/data")
DOK1 <- read_excel_allsheets("DOK.xls")
DOK2 <- read_excel_allsheets("DOK2.xls")
DOK3 <- read_excel_allsheets("DOK3.xls")
rm(read_excel_allsheets)
```



# Animal 

The sheets containing general information about all the cattle in the herd are combined in a single data set called *Animal* and keeping only the 5 variables that are relevant for this analysis.
```{r}
Animal1 <- DOK1$Animal
Animal2 <- DOK2$Animal
Animal3 <- DOK3$Animal
Animal <- rbind(Animal1, Animal2, Animal3) %>%
  select(AnimalNumber, MotherAnimalNumber, HerdNumber, AnimalRaceId, AnimalStatusId)
rm(Animal1, Animal2, Animal3)
```





# Animal health

All sheets containing health information about all of the cattle are also combined into a single data set. This data set contains an overview of registered diagnoses of the herds meaning that cattle that have never been diagnosed with a disease do not appear in this data set. 
```{r}
Animalhealth1 <- DOK1$AnimalHealth
Animalhealth2 <- DOK2$AnimalHealth
Animalhealth3 <- DOK3$AnimalHealth
Animalhealth <- rbind(Animalhealth1, Animalhealth2, Animalhealth3) %>%
    select(AnimalNumber, DiseaseTypeId, Date)
rm(Animalhealth1, Animalhealth2, Animalhealth3)
```


Removing all DiseaseTypeIds related to calves since diseases for adult cattle is the subject of interest.
```{r}
Animalhealth %<>%
  filter(!(DiseaseTypeId == 577 | DiseaseTypeId == 702 | DiseaseTypeId == 783 | DiseaseTypeId == 639 | DiseaseTypeId == 640 | DiseaseTypeId ==  1073 | DiseaseTypeId ==  909 | DiseaseTypeId == 576 | DiseaseTypeId == 889))
```


In order to combine the general information about the cattle with their medical history the 2 data sets are joined in *Data_raw*.
```{r}
Data_raw <- Animalhealth %>% full_join(Animal, by = "AnimalNumber") %>%
  distinct(AnimalNumber, DiseaseTypeId, Date, MotherAnimalNumber, HerdNumber, AnimalRaceId, .keep_all = TRUE)

rm(Animal, Animalhealth)
```

A `count()` shows that 63 different *DiseaseTypeId*s exist in the data where *DiseaseTypeID* = NA occured when joining the data sets meaning that an NA in this variable indicates that the animal has never been diagnosed with a disease. 
```{r}
Data_raw %>%
    count(DiseaseTypeId) %>%
    arrange(desc(n))
```

Since the aim of the project is to predict diseases in cows, heifers, bulls and bull calves are removed from the data.
```{r}
Data_raw %<>%
  filter(AnimalStatusId == 24) %>%
  select(-AnimalStatusId)
```



# Diseasetype

Since *DiseaseTypeID* is not very informative the description of this variable is added to the data by first importing the data and selecting the only 2 relevant variables and using `left_join()` to add it to the existing *Data_raw*.
```{r}
Diseasetype <- DOK1$DiseaseType

Diseasetype %<>%
  select(RowId, Description)

Data_raw %<>% left_join(Diseasetype, by = c("DiseaseTypeId" = "RowId"))
rm(Diseasetype)
```

Since the *Description* variable contains NA's for all healthy animals these are replaced by "Healthy". A `count()` is then performed on the *description* to see how common each of the diseases are. 
```{r}
Data_raw %<>%
  mutate(Description = Description %>% replace_na("Healthy")) 

Data_raw %>%
    count(Description) %>%
    arrange(desc(n))
```

In order to avoid unnecessary complications in the future the Danish letters "æ", "ø", and "å" are replaced with "ae", "oe" and "aa" in the *Description* variable.
```{r}
Data_raw %<>%
  mutate(Description = str_replace_all(Description, "æ|<U+00E6>", "ae") ) %>%
  mutate(Description = str_replace_all(Description, "ø|<U+00F8>", "oe"))  %>%
  mutate(Description = str_replace_all(Description, "å|<U+00E5>", "aa"))
```




# Clinical parameters

It is assumed that clinical parameters can be used as an indicator of whether the animal is healthy or not. The *clinical* data set contains information about clinical recordings while *parameter* contains general information about the general parameters. These 2 data sets are loaded and combined in *clinical* using `left_join()` and only the 4 relevant variables are kept.

```{r}
clinical1 <- DOK1$ClinicalRecording
clinical2 <- DOK2$ClinicalRecording
clinical3 <- DOK3$ClinicalRecording
clinical <- rbind(clinical1, clinical2, clinical3)
rm(clinical1, clinical2, clinical3)
```

```{r}
parameter <- DOK1$ClinicalParameter
```

```{r}
clinical %<>% left_join(parameter, by = c("ClinicalParameterId" = "RowId")) %>%
  select(AnimalNumber, Date, Description, ClinicalValue)
rm(parameter)
```

Each of the parameters need to appear as individual variables in the data, and therefore the data is pivoted using `pivot_wider()`.
```{r}
clinical %<>%
    pivot_wider(names_from = "Description", values_from = "ClinicalValue")
```

Now that *clinical* has the desired format it is merged with the existing *Data_raw* by *AnimalNumber*. Since the animals are not diagnosed on the same data as they are tested it is not possible to merge by *Date*. 
```{r}
Data_raw %<>% merge(clinical, by = "AnimalNumber", all = TRUE) 
rm(clinical)
```

Since some of the clinical parameters contain Danish letters thay are converted into their non_Danish versions.
```{r}
colnames(Data_raw) <- str_replace_all(colnames(Data_raw) , "æ|\u00e6", "ae")
colnames(Data_raw) <- str_replace_all(colnames(Data_raw) , "ø|\u00f8", "oe")
colnames(Data_raw) <- str_replace_all(colnames(Data_raw) , "å|\u00e5", "aa")
```


When filtering by a single animal it is seen that merging the data this way creates multiple observations for the same date since all test dates (the dates from the *clinical* data set) are joined to each of the diagnosis dates (dates in *Data_raw*).
```{r}
Data_raw %>%
    filter(AnimalNumber == 4110302299) %>%
  select(AnimalNumber, Date.x, DiseaseTypeId, Date.y, Huld) 
```

To overcome occurrence of multiple identical diagnosis dates per animal it is assumed that the parameter values measured closest to and prior to the diagnosis date are decisive for the diagnosis. 

Since both *Data_raw* and *clinical* contained a *Data* variable before merging the data set now has a *Date.x* which needs to be renamed as *Date_diagnosis* while *Date.y* whould be renamed *Date_test*. At the same time these variables are transformed into a proper data format.
```{r}
library(lubridate)

Data_raw %<>%
  mutate(Date.x = Date.x %>% as_date()) %>%
  mutate(Date.y = Date.y %>% as_date()) %>%
  rename(Date_diagnosis=Date.x) %>%
  rename(Date_test=Date.y)
```

As mentioned, in the observations where the *Date_test* is closest to and prior to *Date_diagnosis* the test dates are regarded as decisive for the diagnosis, and therefore we only wish to keep these observations in the data using the `filter()` function to keep observations where *Date_test* precede *Date_diagnosis*. The downside of this function is that it automatically removes observations where NAs appear in one of the two date variables, and since NAs in both were created when merging the two data sets these need to be redefined as recognizable and unrealistic dates so it is clear that these are not actual dates from the data sets. We wish to keep these observations in the data so that animals that haven't been tested, diagnosed or both will still be included in the analysis.  

```{r}
date <- ymd("0000-01-01")
date2 <- ymd("3000-01-01")

Data_raw %<>%
  mutate(Date_diagnosis = case_when(is.na(Date_diagnosis) ~ date2, TRUE ~ Date_diagnosis)) %>%
  mutate(Date_test = case_when(is.na(Date_test) ~ date, TRUE ~ Date_test))
```

Filtering so that only the tests that precede the diagnosis is included. Note that this removes observations where a test has been performed after the last diagnosis of an animal, and thereby cows that should actually be coded as "Healthy". Removing observations of healthy animals is not optimal, but no solution to this problem was found.
```{r}
Data_raw %<>%
  group_by(AnimalNumber) %>%
  filter(Date_diagnosis >= Date_test) %>%
  ungroup()
```

The dates are then filtered for the individual animals and diagnosis so that only the most recent *Date_test* remains.
```{r}
Data_raw %<>% group_by(AnimalNumber, Date_diagnosis) %>%
    filter(Date_test == max(Date_test)) %>%
  ungroup()
```

The data now consist of observations where *Date_test* precede *Date_diagnosis*, but the measured parameter values likely only have an impact of the diagnosis if the test is performed within a reasonable amount of time before the diagnosis is made. In this case, this interval is set to 14 days. In observations where the diagnosis is made within 14 days of the test data, the *DiseaseTypeId* is kept, but if the diagnosis is made after 14 days and before 30 days, the *DiseaseTypeId* is changed to 0 indicating that the animal is healthy. The 30 day limit is used to prevent that the *DiseaseTypeId* is not changed for animals that are diagnosed without a test as basis.
```{r}
Data_raw%<>%
  mutate(DiseaseTypeId = DiseaseTypeId %>% replace_na(0)) %>%
  mutate(diff = as.duration(Date_test %--% Date_diagnosis) / ddays()) %>%
  mutate(DiseaseTypeId = ifelse(diff <= 14| diff > 700000, DiseaseTypeId, 0)) %>% # Changing DiseaseTypeID to reflect whether or not the test occured within 14 days before the disease. If so the disease is kept
  mutate(DiseaseTypeId = ifelse(diff >= 15 & diff <=30, 0, DiseaseTypeId)) # If a test precedes the disease by more than 14 days the DiseaseTypeId is changed to reflect that the animal wasn't sick based on the test. An upper limit is set to insure that animals that become sick without a test does not change their DiseaseTypeId
```

To ensure unique observations the `distinct()` function is used.
```{r}
Data_raw %<>%
  distinct(AnimalNumber, Date_test, DiseaseTypeId, .keep_all=TRUE) %>%
  drop_na(DiseaseTypeId)
```


For convenience some of the variables are renamed into more coding firendly names.
```{r}
Data_raw %<>%
  mutate(Huld = Huld %>% str_replace_all(",", ".")) %>%
  rename(Andre_trykninger = `Andre trykninger`) %>%
  rename(Hud_Haarlag = `Hud- og Haarlag`) %>%
  rename(Hygiejne_yver = `Hygiejne yver`) %>%
  rename(Hygiejne_haser = `Hygiejne haser`) %>%
  rename(Ketonstof_urin = `Ketonstof urin`) %>%
  rename(CMT_min_1_kirtel = `CMT, min. 1 kirtel`)
```

```{r}
Data_raw %<>%
  select(-Dyrestatus)
```



# Calving 

It is assumed that calving can have an impact on the cows health so data regarding calving is merged with *Data_raw* using the same steps as earlier.
```{r}
Calving1 <- DOK1$Calving
Calving2 <- DOK2$Calving
Calving3 <- DOK3$Calving
Calving <- rbind(Calving1, Calving2, Calving3) %>% 
  select(CalvingDate, MotherAnimalNumber, LactationNumber)

rm(Calving1, Calving2, Calving3)
```

Again, the date variable is transformed into a proper format and renamed to match the other date variables in *Data_raw*.
```{r}
Calving %<>%
  mutate(CalvingDate = CalvingDate %>% as_date()) %>%
  rename(Date_Calving = CalvingDate)
```

```{r}
Data_raw %<>% left_join(Calving, by = c("AnimalNumber" = "MotherAnimalNumber"))
```

As performed earlier NA's in the date variables are replaced with the two unrealistic dates created earlier to make sure that animals that haven't calved aren't removed from the data, and that animals that have calved but not been diagnosed aren't removed either.
Then, observations where *Date_Calving* precede *Date_diagnosis* are kept in the data. 
```{r}
Data_raw %<>%
  mutate(Date_diagnosis = case_when(is.na(Date_diagnosis) ~ date2, TRUE ~ Date_diagnosis)) %>%
  mutate(Date_Calving= case_when(is.na(Date_Calving) ~ date, TRUE ~ Date_Calving)) %>%
  group_by(AnimalNumber) %>%
  filter(Date_diagnosis >= Date_Calving) %>%
  ungroup()
```


The dates are then filtered for the individual animals and diagnosis so that only the most recent *Date_calving* remains.
```{r}
Data_raw %<>% group_by(AnimalNumber, Date_diagnosis) %>% 
    filter(Date_Calving==max(Date_Calving)) %>%
    ungroup()
```

Creating a new indicator variable *Calving_month* which has the value of 1 if the animal has calved within 30 days and 0 if not.This is based on the assumption that calving can have an impact on the health status of the cow.
```{r}
Data_raw %<>% 
  mutate(Calving_month = 
      as.duration(Date_Calving %--% Date_diagnosis) / ddays()) %>%
  mutate(Calving_month = ifelse(Calving_month < 30, 1, 0))
```

Using `distinct()` to keep unique observations.
```{r}
Data_raw %<>%
 distinct(AnimalNumber, Date_diagnosis, Date_test, Date_Calving, Calving_month, DiseaseTypeId, .keep_all = TRUE)
```

Since it is assumed that observations where LactationNumber is not registered is equivalent to the cow has never lactated/calved, the NAs are replaced with 0s. At the same time uneeded variables are removed from the data.
```{r}
Data_raw %<>%
  mutate(LactationNumber = LactationNumber %>% replace_na(0)) %>%
  select(-Date_Calving, -MotherAnimalNumber, -diff)
```




# Insemination

It is assumed that insemination/pregnancy can have an impact on a cows health and therefore insemination data is merged with *Data_raw* using the same procedure as earlier.

```{r}
Insemination1 <- DOK1$Insemination
Insemination2 <- DOK2$Insemination
Insemination3 <- DOK3$Insemination
Insemination <- rbind(Insemination1, Insemination2, Insemination3) %>% 
  select(Date, AnimalNumber, InseminationNumber)

rm(Insemination1, Insemination2, Insemination3)
```

```{r}
Insemination %<>%
  mutate(Date = Date %>% as_date()) %>%
  rename(Date_Insemination = Date)
```

```{r}
Data_raw %<>% left_join(Insemination, by = "AnimalNumber")

rm(Insemination)
```

Replacing NAs with earlier created unrealistic dates and removing observations where *Date_diagnosis* precede *Date_Insemination*.
```{r}
Data_raw %<>%
  mutate(Date_diagnosis = case_when(is.na(Date_diagnosis) ~ date2, TRUE ~ Date_diagnosis)) %>%
  mutate(Date_Insemination = case_when(is.na(Date_Insemination ) ~ date, TRUE ~ Date_Insemination)) %>%
  group_by(AnimalNumber) %>%
  filter(Date_diagnosis >= Date_Insemination ) %>%
  ungroup()
```

The dates are then filtered for the individual animals and diagnosis so that only the most recent *Date_Insemination* remains.
```{r}
Data_raw %<>% group_by(AnimalNumber, Date_diagnosis) %>% 
    filter(Date_Insemination ==max(Date_Insemination )) %>%
    ungroup()
```

Creating a new indicator variable *Insemination_month* which equals 1 if the cow has been inseminated within a month of being diagnosed and 0 otherwise. 
```{r}
Data_raw %<>% 
  mutate(Insemination_month = 
      as.duration(Date_Insemination %--% Date_diagnosis) / ddays()) %>%
  mutate(Insemination_month = ifelse(Insemination_month < 30, 1, 0))
```

Keeping only unique observations.
```{r}
Data_raw %<>%
  distinct(AnimalNumber, Date_test, Date_Insemination, Insemination_month, DiseaseTypeId, .keep_all = TRUE)
```

Assuming that NAs in the *InseminationNumber* means that the cow has never been inseminated, the NAs are replaced with 0s.
```{r}
Data_raw %<>%
  mutate(InseminationNumber = InseminationNumber %>% replace_na(0))
```

Removing unneeded variables from the data.
```{r}
Data_raw %<>%
  select(-Date_Insemination)
```



# Productivity

It is assumed that the productivity of a cow (the production of milk) can be used as an indicator of disease. For this reason the Milk Recording data is merged with *Data_raw* using the same procedure as earlier.
```{r}
Productivity1 <- DOK1$MilkRecording
Productivity2 <- DOK2$MilkRecording
Productivity3 <- DOK3$MilkRecording
Productivity <- rbind(Productivity1, Productivity2, Productivity3) %>% 
  select(DateRecorded, AnimalNumber, MilkYield)

rm(Productivity1, Productivity2, Productivity3)
```

```{r}
Productivity %<>%
  mutate(DateRecorded = DateRecorded %>% as_date()) %>%
  rename(Date_Productivity = DateRecorded)
```

```{r}
Data_raw %<>% left_join(Productivity, by = "AnimalNumber")

rm(Productivity)
```

```{r}
Data_raw %>%
  count(is.na(MilkYield))
```
Since the number of NAs in this variable is not very large they will just be imputed before modelling.

A new variable, *Change_milkyield*, is created measuring the change in the milk yield since last registration on the same cow. 
```{r}
Data_raw %<>%
  group_by(AnimalNumber, Date_diagnosis) %>%
  mutate(Change_milkyield = ifelse(AnimalNumber == lag(AnimalNumber), MilkYield - lag(MilkYield), NA) %>% round(2)) %>%
  mutate(Change_milkyield = Change_milkyield %>% replace_na(0)) %>%
  ungroup()
```

```{r}
Data_raw %<>%
  mutate(Date_diagnosis = case_when(is.na(Date_diagnosis) ~ date2, TRUE ~ Date_diagnosis)) %>%
  mutate(Date_Productivity= case_when(is.na(Date_Productivity) ~ date, TRUE ~ Date_Productivity)) %>%
  group_by(AnimalNumber) %>%
  filter(Date_diagnosis >= Date_Productivity) %>%
  ungroup() 
```

```{r}
Data_raw %<>% group_by(AnimalNumber, Date_diagnosis) %>% 
    filter(Date_Productivity ==max(Date_Productivity)) %>%
    ungroup() %>%
    distinct(AnimalNumber, Date_Productivity, DiseaseTypeId, MilkYield, Change_milkyield, .keep_all = TRUE) %>%
    select(-Date_Productivity)
```



# Data cleaning

As a last preperation som data cleaning, renaming of variable categories and removing unneeded variables is done. 
```{r}
Data_raw %<>%
  mutate(HerdNumber = ifelse(HerdNumber == 41103, 1,
                      ifelse(HerdNumber == 54028, 2, 3)) %>% as.factor())
```

```{r}
Data_raw %<>%
  rename(Race = AnimalRaceId) %>%
  drop_na(Race) %>%
  mutate(Race = ifelse(Race == 162, "Red Danish Dairy Breed",
                ifelse(Race == 163, "Danish Holstein",
                ifelse(Race == 165, "Danish Jersey",
                ifelse(Race == 169, "Danish red and white Cattle", "Simmental")))) %>% as.factor())
```


```{r}
Data <- Data_raw %>%
  rename(Disease = Description) %>%
  select(-AnimalNumber, -Date_diagnosis, -Date_test, -DiseaseTypeId)
```

# Removing Diseases with only a few observations

```{r}
Data %>%
  count(Disease) %>%
  arrange(n)
```
The `count()` shows that many of the Diseases has only a few observations. Since they probably won't contribute much to a model but rather disturb, diseases appearing less than 50 times are removed from the data.

```{r}
Data %<>%
  add_count(Disease) %>%
  arrange(n) %>%
  filter(n>49) %>%
  select(-n)
```


# Creating Disease Categories
The data set contains 21 different diseases and these will be categorised into larger groups in order to make the model. 


The diseases is categorised according to [Landbrug & Foedevarer](https://www.landbrugsinfo.dk/public/7/8/7/sundhed_og_sygdomme_dms_dyreregistrering_koder_til_registrering), but since "Klovbeskaering", "Vaccine", "Forundersoegelse" and "Brunst" are not diseases they are placed in the category "Healthy". 
```{r}
Data %<>%
  mutate(DiseaseCategory = ifelse(Disease =="Kaelvningsfeber" | 
                                  #Disease == "Loebedrejning" |
                                  #Disease == "Ford./stofskiftelidelse, andet" |
                                  Disease=="Ketose", "Metabolic disorders", 
                         ifelse(#Disease =="Asymmetrisk klov" |
                                  #Disease =="Betaendelse, klovspalte"|
                                  Disease == "Digital dermatitis" |
                                  #Disease =="Digital vorte"|
                                  #Disease == "Balleraad"|
                                  #Disease =="Dobbeltsaal"|
                                  #Disease =="Halthedsscore"|
                                  #Disease =="Hul vaeg, byld i hvid linje"|
                                  Disease =="Hul vaeg/loes hvid linje"|
                                  Disease =="Klovbrandbyld"|
                                  #Disease =="Klovspalte, nydannelse"|
                                  #Disease =="Lemmelidelse, andet"|
                                  #Disease =="Overgroet klov"|
                                  Disease =="Saalebloedning"|
                                  #Disease =="Saalesaar"|
                                  #Disease =="Sakseklov"|
                                  #Disease =="Taanekrose"
                                  Disease =="Tyk has", "Hoof and limb disorders",
                          ifelse(#Disease == "Abort" | 
                                  Disease == "Brunstinduktion" | 
                                  Disease == "Cyster" | 
                                 # Disease == "Efterbyrd" | 
                                  #Disease == "Foedselshjaelp" | 
                                  #Disease == "Bloedning" | 
                                  #Disease == "Kastration/studning" |
                                  Disease == "Boerbetaendelse", "Reproduction disorders",
                          ifelse(Disease == "CNS"|
                                  #Disease == "E-coli"|
                                  Disease == "Goldningsbehandling"|
                                  #Disease == "Gaer"|
                                 # Disease == "Ingen vaekst"|
                                  Disease == "Intern pattelukning"|
                                 # Disease == "Klebsiella"|
                                  Disease == "Staph. Aureus"|
                                  #Disease == "Strept. Uberis"|
                                  #Disease == "Streptokok agalactia - gr. B. strep-tokokker"|
                                  Disease == "Streptokok dysgalactia"|
                                  #Disease == "Yverbetaendelse, akut"|
                                  Disease == "Yverbetaendelse", "Udder disorders",
                          ifelse(Disease=="Healthy" |
                                  Disease == "Vaccine" |
                                  Disease == "Brunst" |
                                  Disease == "Forundersoegelse" |
                                  Disease =="Klovbeskaering" , "Healthy", 0))))) %>% as.factor())
```

The data set is saved as a .csv file.
```{r}
library(rtweet)
write_as_csv(Data, "Cows")
```







